"use strict";
const _ = require("underscore");
const compareVersions = require("compare-versions");
function escapeChar(match) {
    switch (match) {
        case '&': return '&amp;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case ' ': return '&nbsp;';
        default: return match;
    }
}
function escapeString(inp) {
    return inp.replace(/[&"'<>]/g, escapeChar);
}
function escapeStringNbsp(inp) {
    return inp.replace(/[&"'<> ]/g, escapeChar);
}
function pushScope(scopeStack, scope, html) {
    scopeStack.push(scope);
    html.push(`<span class="${scope.replace(/\.+/g, ' ')}">`);
}
function popScope(scopeStack, html) {
    scopeStack.pop();
    html.push('</span>');
}
function updateScopeStack(scopeStack, desiredScopes, html) {
    let excessScopes = scopeStack.length - desiredScopes.length;
    if (excessScopes > 0) {
        while (excessScopes--) {
            popScope(scopeStack, html);
        }
    }
    let lasti = 0;
    for (let i = scopeStack.length; i >= 0; --i) {
        if (_.isEqual(scopeStack.slice(0, i), desiredScopes.slice(0, i))) {
            lasti = i;
            break;
        }
        popScope(scopeStack, html);
    }
    for (let j = lasti; j < desiredScopes.length; ++j) {
        pushScope(scopeStack, desiredScopes[j], html);
    }
}
const defaultOptions = {
    nbsp: true,
    lineDivs: false,
    editorDiv: false,
    wrapCode: false,
    editorDivTag: 'div',
    editorDivClass: 'editor editor-colors',
    nullScope: 'text.plain.null-grammar',
};
module.exports = function highlightSync(options) {
    const registry = atom.grammars;
    const o = Object.assign({}, defaultOptions, options);
    const grammar = registry.grammarForScopeName(o.scopeName) || (o.nullScope ? registry.grammarForScopeName(o.nullScope) : undefined);
    if (grammar === undefined) {
        throw new Error(`Grammar ${o.scopeName} not found, and no ${o.nullScope} grammar`);
    }
    const lineTokens = grammar.tokenizeLines(o.fileContents);
    if (lineTokens.length > 0) {
        const lastLineTokens = lineTokens[lineTokens.length - 1];
        if (lastLineTokens.length === 1 && lastLineTokens[0].value === '') {
            lineTokens.pop();
        }
    }
    const escape = o.nbsp ? escapeStringNbsp : escapeString;
    const html = [];
    if (o.editorDiv)
        html.push(`<${o.editorDivTag} class="${o.editorDivClass}">`);
    if (o.wrapCode)
        html.push('<code>');
    for (const tokens of lineTokens) {
        const scopeStack = [];
        if (o.lineDivs)
            html.push('<div class="line">');
        for (const { value, scopes } of tokens) {
            let newScopes = scopes;
            if (compareVersions(atom.getVersion(), '1.13.0') >= 0) {
                newScopes = scopes.map((s) => `syntax--${s.replace(/\./g, '.syntax--')}`);
            }
            updateScopeStack(scopeStack, newScopes, html);
            html.push(`<span>${escape(value)}</span>`);
        }
        while (scopeStack.length > 0) {
            popScope(scopeStack, html);
        }
        if (o.lineDivs)
            html.push('</div>');
        html.push('\n');
    }
    if (o.wrapCode)
        html.push('</code>');
    if (o.editorDiv)
        html.push(`</${o.editorDivTag}>`);
    return html.join('');
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2hpZ2hsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsZ0NBQWdDO0FBQ2hDLG9EQUFvRDtBQUdwRCxvQkFBb0IsS0FBYTtJQUMvQixNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ2QsS0FBSyxHQUFHLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQTtRQUN4QixLQUFLLEdBQUcsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFBO1FBQ3pCLEtBQUssR0FBRyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUE7UUFDeEIsS0FBSyxHQUFHLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUN2QixLQUFLLEdBQUcsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFBO1FBQ3ZCLEtBQUssR0FBRyxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUE7UUFDekIsU0FBUyxNQUFNLENBQUMsS0FBSyxDQUFBO0lBQ3ZCLENBQUM7QUFDSCxDQUFDO0FBRUQsc0JBQXNCLEdBQVc7SUFDL0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQzVDLENBQUM7QUFFRCwwQkFBMEIsR0FBVztJQUNuQyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUE7QUFDN0MsQ0FBQztBQUVELG1CQUFtQixVQUFvQixFQUFFLEtBQWEsRUFBRSxJQUFjO0lBQ3BFLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQzNELENBQUM7QUFFRCxrQkFBa0IsVUFBb0IsRUFBRSxJQUFjO0lBQ3BELFVBQVUsQ0FBQyxHQUFHLEVBQUUs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QUksQ0FBQyxTQUFTLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDNUMsQ0FBQztRQUNELE9BQU8sVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUM3QixRQUFRLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQzVCLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO1lBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUNuQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ2pCLENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO1FBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUNwQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFBO0lBQ2xELE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0FBQ3RCLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpXG5pbXBvcnQgY29tcGFyZVZlcnNpb25zID0gcmVxdWlyZSgnY29tcGFyZS12ZXJzaW9ucycpXG5pbXBvcnQge30gZnJvbSAnYXRvbSdcblxuZnVuY3Rpb24gZXNjYXBlQ2hhcihtYXRjaDogc3RyaW5nKTogc3RyaW5nIHtcbiAgc3dpdGNoIChtYXRjaCkge1xuICAgIGNhc2UgJyYnOiByZXR1cm4gJyZhbXA7J1xuICAgIGNhc2UgJ1wiJzogcmV0dXJuICcmcXVvdDsnXG4gICAgY2FzZSBcIidcIjogcmV0dXJuICcmIzM5OydcbiAgICBjYXNlICc8JzogcmV0dXJuICcmbHQ7J1xuICAgIGNhc2UgJz4nOiByZXR1cm4gJyZndDsnXG4gICAgY2FzZSAnICc6IHJldHVybiAnJm5ic3A7J1xuICAgIGRlZmF1bHQ6IHJldHVybiBtYXRjaFxuICB9XG59XG5cbmZ1bmN0aW9uIGVzY2FwZVN0cmluZyhpbnA6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBpbnAucmVwbGFjZSgvWyZcIic8Pl0vZywgZXNjYXBlQ2hhcilcbn1cblxuZnVuY3Rpb24gZXNjYXBlU3RyaW5nTmJzcChpbnA6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBpbnAucmVwbGFjZSgvWyZcIic8PiBdL2csIGVzY2FwZUNoYXIpXG59XG5cbmZ1bmN0aW9uIHB1c2hTY29wZShzY29wZVN0YWNrOiBzdHJpbmdbXSwgc2NvcGU6IHN0cmluZywgaHRtbDogc3RyaW5nW10pOiB2b2lkIHtcbiAgc2NvcGVTdGFjay5wdXNoKHNjb3BlKVxuICBodG1sLnB1c2goYDxzcGFuIGNsYXNzPVwiJHtzY29wZS5yZXBsYWNlKC9cXC4rL2csICcgJyl9XCI+YClcbn1cblxuZnVuY3Rpb24gcG9wU2NvcGUoc2NvcGVTdGFjazogc3RyaW5nW10sIGh0bWw6IHN0cmluZ1tdKTogdm9pZCB7XG4gIHNjb3BlU3RhY2sucG9wKClcbiAgaHRtbC5wdXNoKCc8L3NwYW4+Jylcbn1cblxuZnVuY3Rpb24gdXBkYXRlU2NvcGVTdGFjayhzY29wZVN0YWNrOiBzdHJpbmdbXSwgZGVzaXJlZFNjb3Blczogc3RyaW5nW10sIGh0bWw6IHN0cmluZ1tdKTogdm9pZCB7XG4gIGxldCBleGNlc3NTY29wZXMgPSBzY29wZVN0YWNrLmxlbmd0aCAtIGRlc2lyZWRTY29wZXMubGVuZ3RoXG4gIGlmIChleGNlc3NTY29wZXMgPiAwKSB7XG4gICAgd2hpbGUgKGV4Y2Vzc1Njb3Blcy0tKSB7XG4gICAgICBwb3BTY29wZShzY29wZVN0YWNrLCBodG1sKVxuICAgIH1cbiAgfVxuXG4gIC8vIHBvcCB1bnRpbCBjb21tb24gcHJlZml4XG4gIGxldCBsYXN0aSA9IDBcbiAgZm9yIChsZXQgaSA9IHNjb3BlU3RhY2subGVuZ3RoOyBpID49IDA7IC0taSkge1xuICAgIGlmIChfLmlzRXF1YWwoc2NvcGVTdGFjay5zbGljZSgwLCBpKSwgZGVzaXJlZFNjb3Blcy5zbGljZSgwLCBpKSkpIHtcbiAgICAgIGxhc3RpID0gaVxuICAgICAgYnJlYWtcbiAgICB9XG4gICAgcG9wU2NvcGUoc2NvcGVTdGFjaywgaHRtbClcbiAgfVxuICAvLyBwdXNoIG9uIHRvcCBvZiBjb21tb24gcHJlZml4IHVudGlsIHNjb3BlU3RhY2sgaXMgZGVzaXJlZFNjb3Blc1xuICBmb3IgKGxldCBqID0gbGFzdGk7IGogPCBkZXNpcmVkU2NvcGVzLmxlbmd0aDsgKytqKSB7XG4gICAgcHVzaFNjb3BlKHNjb3BlU3RhY2ssIGRlc2lyZWRTY29wZXNbal0sIGh0bWwpXG4gIH1cbn1cblxuY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gIG5ic3A6IHRydWUsXG4gIGxpbmVEaXZzOiBmYWxzZSxcbiAgZWRpdG9yRGl2OiBmYWxzZSxcbiAgd3JhcENvZGU6IGZhbHNlLFxuICBlZGl0b3JEaXZUYWc6ICdkaXYnLFxuICBlZGl0b3JEaXZDbGFzczogJ2VkaXRvciBlZGl0b3ItY29sb3JzJyxcbiAgbnVsbFNjb3BlOiAndGV4dC5wbGFpbi5udWxsLWdyYW1tYXInLFxufVxuXG5leHBvcnQgPSBmdW5jdGlvbiBoaWdobGlnaHRTeW5jKFxuICBvcHRpb25zOiB7XG4gICAgZmlsZUNvbnRlbnRzOiBzdHJpbmdcbiAgICBzY29wZU5hbWU6IHN0cmluZ1xuICB9ICYgUGFydGlhbDx7XG4gICAgbmJzcDogYm9vbGVhblxuICAgIGxpbmVEaXZzOiBib29sZWFuXG4gICAgZWRpdG9yRGl2OiBib29sZWFuXG4gICAgd3JhcENvZGU6IGJvb2xlYW5cbiAgICBlZGl0b3JEaXZUYWc6IHN0cmluZ1xuICAgIGVkaXRvckRpdkNsYXNzOiBzdHJpbmdcbiAgICBudWxsU2NvcGU6IHN0cmluZ1xuICB9Pixcbik6IHN0cmluZyB7XG4gIGNvbnN0IHJlZ2lzdHJ5ID0gYXRvbS5ncmFtbWFyc1xuICBjb25zdCBvID0gey4uLmRlZmF1bHRPcHRpb25zLCAuLi5vcHRpb25zfVxuXG4gIGNvbnN0IGdyYW1tYXIgPSByZWdpc3RyeS5ncmFtbWFyRm9yU2NvcGVOYW1lKG8uc2NvcGVOYW1lKSB8fCAoby5udWxsU2NvcGUgPyByZWdpc3RyeS5ncmFtbWFyRm9yU2NvcGVOYW1lKG8ubnVsbFNjb3BlKSA6IHVuZGVmaW5lZClcbiAgaWYgKGdyYW1tYXIgPT09IHVuZGVmaW5lZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgR3JhbW1hciAke28uc2NvcGVOYW1lfSBub3QgZm91bmQsIGFuZCBubyAke28ubnVsbFNjb3BlfSBncmFtbWFyYClcbiAgfVxuXG4gIGNvbnN0IGxpbmVUb2tlbnMgPSBncmFtbWFyLnRva2VuaXplTGluZXMoby5maWxlQ29udGVudHMpXG5cbiAgLy8gUmVtb3ZlIHRyYWlsaW5nIG5ld2xpbmVcbiAgaWYgKGxpbmVUb2tlbnMubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IGxhc3RMaW5lVG9rZW5zID0gbGluZVRva2Vuc1tsaW5lVG9rZW5zLmxlbmd0aCAtIDFdXG5cbiAgICBpZiAobGFzdExpbmVUb2tlbnMubGVuZ3RoID09PSAxICYmIGxhc3RMaW5lVG9rZW5zWzBdLnZhbHVlID09PSAnJykge1xuICAgICAgbGluZVRva2Vucy5wb3AoKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGVzY2FwZSA9IG8ubmJzcCA/IGVzY2FwZVN0cmluZ05ic3AgOiBlc2NhcGVTdHJpbmdcblxuICBjb25zdCBodG1sOiBzdHJpbmdbXSA9IFtdXG4gIGlmIChvLmVkaXRvckRpdikgaHRtbC5wdXNoKGA8JHtvLmVkaXRvckRpdlRhZ30gY2xhc3M9XCIke28uZWRpdG9yRGl2Q2xhc3N9XCI+YClcbiAgaWYgKG8ud3JhcENvZGUpIGh0bWwucHVzaCgnPGNvZGU+JylcbiAgZm9yIChjb25zdCB0b2tlbnMgb2YgbGluZVRva2Vucykge1xuICAgIGNvbnN0IHNjb3BlU3RhY2s6IHN0cmluZ1tdID0gW11cbiAgICBpZiAoby5saW5lRGl2cykgaHRtbC5wdXNoKCc8ZGl2IGNsYXNzPVwibGluZVwiPicpXG4gICAgZm9yIChjb25zdCB7dmFsdWUsIHNjb3Blc30gb2YgdG9rZW5zKSB7XG4gICAgICBsZXQgbmV3U2NvcGVzID0gc2NvcGVzXG4gICAgICBpZiAoY29tcGFyZVZlcnNpb25zKGF0b20uZ2V0VmVyc2lvbigpLCAnMS4xMy4wJykgPj0gMCkge1xuICAgICAgICBuZXdTY29wZXMgPSBzY29wZXMubWFwKChzOiBzdHJpbmcpID0+IGBzeW50YXgtLSR7cy5yZXBsYWNlKC9cXC4vZywgJy5zeW50YXgtLScpfWApXG4gICAgICB9XG4gICAgICB1cGRhdGVTY29wZVN0YWNrKHNjb3BlU3RhY2ssIG5ld1Njb3BlcywgaHRtbClcbiAgICAgIGh0bWwucHVzaChgPHNwYW4+JHtlc2NhcGUodmFsdWUpfTwvc3Bhbj5gKVxuICAgIH1cbiAgICB3aGlsZSAoc2NvcGVTdGFjay5sZW5ndGggPiAwKSB7XG4gICAgICBwb3BTY29wZShzY29wZVN0YWNrLCBodG1sKVxuICAgIH1cbiAgICBpZiAoby5saW5lRGl2cykgaHRtbC5wdXNoKCc8L2Rpdj4nKVxuICAgIGh0bWwucHVzaCgnXFxuJylcbiAgfVxuICBpZiAoby53cmFwQ29kZSkgaHRtbC5wdXNoKCc8L2NvZGU+JylcbiAgaWYgKG8uZWRpdG9yRGl2KSBodG1sLnB1c2goYDwvJHtvLmVkaXRvckRpdlRhZ30+YClcbiAgcmV0dXJuIGh0bWwuam9pbignJylcbn1cbiJdfQ==