"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const languageclient_1 = require("../languageclient");
const convert_1 = require("../convert");
// Public: Listen to diagnostics messages from the language server and publish them
// to the user by way of the Linter Push (Indie) v2 API supported by Atom IDE UI.
class LinterPushV2Adapter {
    // Public: Create a new {LinterPushV2Adapter} that will listen for diagnostics
    // via the supplied {LanguageClientConnection}.
    //
    // * `connection` A {LanguageClientConnection} to the language server that will provide diagnostics.
    constructor(connection) {
        this._diagnosticMap = new Map();
        this._diagnosticCodes = new Map();
        this._indies = new Set();
        connection.onPublishDiagnostics(this.captureDiagnostics.bind(this));
    }
    // Dispose this adapter ensuring any resources are freed and events unhooked.
    dispose() {
        this.detachAll();
    }
    // Public: Attach this {LinterPushV2Adapter} to a given {V2IndieDelegate} registry.
    //
    // * `indie` A {V2IndieDelegate} that wants to receive messages.
    attach(indie) {
        this._indies.add(indie);
        this._diagnosticMap.forEach((value, key) => indie.setMessages(key, value));
        indie.onDidDestroy(() => {
            this._indies.delete(indie);
        });
    }
    // Public: Remove all {V2IndieDelegate} registries attached to this adapter and clear them.
    //
    // * `indie` A {V2IndieDelegate} that wants to receive messages.
    detachAll() {
        this._indies.forEach((i) => i.clearMessages());
        this._indies.clear();
    }
    // Public: Capture the diagnostics sent from a langguage server, convert them to the
    // Linter V2 format and forward them on to any attached {V2IndieDelegate}s.
    //
    // * `params` The {PublishDiagnosticsParams} received from the language server that should
    //            be captured and forwarded on to any attached {V2IndieDelegate}s.
    captureDiagnostics(params) {
        const path = convert_1.default.uriToPath(params.uri);
        const codeMap = new Map();
        const messages = params.diagnostics.map((d) => {
            const linterMessage = this.diagnosticToV2Message(path, d);
            codeMap.set(getCodeKey(linterMessage.location.position, d.message), d.code);
            return linterMessage;
        });
        this._diagnosticMap.set(path, messages);
        this._diagnosticCodes.set(path, codeMap);
        this._indies.forEach((i) => i.setMessages(path, messages));
    }
    // Public: Convert a single {Diagnostic} received from a language server into a single
    // {V2Message} expected by the Linter V2 API.
    //
    // * `path` A string representing the path of the file the diagnostic belongs to.
    // * `diagnostics` A {Diagnostic} object received from the language server.
    //
    // Returns a {V2Message} equivalent to the {Diagnostic} object supplied by the language server.
    diagnosticToV2Message(path, diagnostic) {
        return {
            location: {
                file: path,
                position: convert_1.default.lsRangeToAtomRange(diagnostic.range),
            },
            excerpt: diagnostic.message,
            linterName: diagnostic.source,
            severity: LinterPushV2Adapter.diagnosticSeverityToSeverity(diagnostic.severity || -1),
        };
    }
    // Public: Convert a diagnostic severity number obtained from the language server into
    // the textual equivalent for a Linter {V2Message}.
    //
    // * `severity` A number representing the severity of the diagnostic.
    //
    // Returns a string of 'error', 'warning' or 'info' depending on the severity.
    static diagnosticSeverityToSeverity(severity) {
        switch (severity) {
            case languageclient_1.DiagnosticSeverity.Error:
                return 'error';
            case languageclient_1.DiagnosticSeverity.Warning:
                return 'warning';
            case languageclient_1.DiagnosticSeverity.Information:
            case languageclient_1.DiagnosticSeverity.Hint:
            default:
                return 'info';
        }
    }
    // Private: Get the recorded diagnostic code for a range/message.
    // Diagnostic codes are tricky because there's no suitable place in the Linter API for them.
    // For now, we'll record the original code for each range/message combination and retrieve it
    // when needed (e.g. for passing back into code actions)
    getDiagnosticCode(editor, range, text) {
        const path = editor.getPath();
        if (path != null) {
            const diagnosticCodes = this._diagnosticCodes.get(path);
            if (diagnosticCodes != null) {
                return diagnosticCodes.get(getCodeKey(range, text)) || null;
            }
        }
        return null;
    }
}
exports.default = LinterPushV2Adapter;
function getCodeKey(range, text) {
    return [].concat(...range.serialize(), text).join(',');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGludGVyLXB1c2gtdjItYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9saW50ZXItcHVzaC12Mi1hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsc0RBTTJCO0FBQzNCLHdDQUFpQztBQUVqQyxtRkFBbUY7QUFDbkYsaUZBQWlGO0FBQ2pGO0lBS0UsOEVBQThFO0lBQzlFLCtDQUErQztJQUMvQyxFQUFFO0lBQ0Ysb0dBQW9HO0lBQ3BHLFlBQVksVUFBb0M7UUFSeEMsbUJBQWMsR0FBa0MsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMxRCxxQkFBZ0IsR0FBb0QsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM5RSxZQUFPLEdBQThCLElBQUksR0FBRyxFQUFFLENBQUM7UUFPckQsVUFBVSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBRUQsNkVBQTZFO0lBQ3RFLE9BQU87UUFDWixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDbkIsQ0FBQztJQUVELG1GQUFtRjtJQUNuRixFQUFFO0lBQ0YsZ0VBQWdFO0lBQ3pELE1BQU0sQ0FBQyxLQUEyQjtRQUN2QyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4QixJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDM0UsS0FBSyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUU7WUFDdEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsMkZBQTJG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LE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM5QixFQUFFLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNqQixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hELEVBQUUsQ0FBQyxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUM1QixNQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDO1lBQzlELENBQUM7UUFDSCxDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRjtBQTNHRCxzQ0EyR0M7QUFFRCxvQkFBb0IsS0FBaUIsRUFBRSxJQUFZO0lBQ2pELE1BQU0sQ0FBRSxFQUFZLENBQUMsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDLFNBQVMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNwRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbGludGVyIGZyb20gJ2F0b20vbGludGVyJztcclxuaW1wb3J0ICogYXMgYXRvbSBmcm9tICdhdG9tJztcclxuaW1wb3J0IHtcclxuICBEaWFnbm9zdGljLFxyXG4gIERpYWdub3N0aWNDb2RlLFxyXG4gIERpYWdub3N0aWNTZXZlcml0eSxcclxuICBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXHJcbiAgUHVibGlzaERpYWdub3N0aWNzUGFyYW1zLFxyXG59IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcclxuaW1wb3J0IENvbnZlcnQgZnJvbSAnLi4vY29udmVydCc7XHJcblxyXG4vLyBQdWJsaWM6IExpc3RlbiB0byBkaWFnbm9zdGljcyBtZXNzYWdlcyBmcm9tIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgYW5kIHB1Ymxpc2ggdGhlbVxyXG4vLyB0byB0aGUgdXNlciBieSB3YXkgb2YgdGhlIExpbnRlciBQdXNoIChJbmRpZSkgdjIgQVBJIHN1cHBvcnRlZCBieSBBdG9tIElERSBVSS5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTGludGVyUHVzaFYyQWRhcHRlciB7XHJcbiAgcHJpdmF0ZSBfZGlhZ25vc3RpY01hcDogTWFwPHN0cmluZywgbGludGVyLk1lc3NhZ2VbXT4gPSBuZXcgTWFwKCk7XHJcbiAgcHJpdmF0ZSBfZGlhZ25vc3RpY0NvZGVzOiBNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCBEaWFnbm9zdGljQ29kZSB8IG51bGw+PiA9IG5ldyBNYXAoKTtcclxuICBwcml2YXRlIF9pbmRpZXM6IFNldDxsaW50ZXIuSW5kaWVEZWxlZ2F0ZT4gPSBuZXcgU2V0KCk7XHJcblxyXG4gIC8vIFB1YmxpYzogQ3JlYXRlIGEgbmV3IHtMaW50ZXJQdXNoVjJBZGFwdGVyfSB0aGF0IHdpbGwgbGlzdGVuIGZvciBkaWFnbm9zdGljc1xyXG4gIC8vIHZpYSB0aGUgc3VwcGxpZWQge0xhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbn0uXHJcbiAgLy9cclxuICAvLyAqIGBjb25uZWN0aW9uYCBBIHtMYW5ndWFnZUNsaWVudENvbm5lY3Rpb259IHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgdGhhdCB3aWxsIHByb3ZpZGUgZGlhZ25vc3RpY3MuXHJcbiAgY29uc3RydWN0b3IoY29ubmVjdGlvbjogTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uKSB7XHJcbiAgICBjb25uZWN0aW9uLm9uUHVibGlzaERpYWdub3N0aWNzKHRoaXMuY2FwdHVyZURpYWdub3N0aWNzLmJpbmQodGhpcykpO1xyXG4gIH1cclxuXHJcbiAgLy8gRGlzcG9zZSB0aGlzIGFkYXB0ZXIgZW5zdXJpbmcgYW55IHJlc291cmNlcyBhcmUgZnJlZWQgYW5kIGV2ZW50cyB1bmhvb2tlZC5cclxuICBwdWJsaWMgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGV0YWNoQWxsKCk7XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IEF0dGFjaCB0aGlzIHtMaW50ZXJQdXNoVjJBZGFwdGVyfSB0byBhIGdpdmVuIHtWMkluZGllRGVsZWdhdGV9IHJlZ2lzdHJ5LlxyXG4gIC8vXHJcbiAgLy8gKiBgaW5kaWVgIEEge1YySW5kaWVEZWxlZ2F0ZX0gdGhhdCB3YW50cyB0byByZWNlaXZlIG1lc3NhZ2VzLlxyXG4gIHB1YmxpYyBhdHRhY2goaW5kaWU6IGxpbnRlci5JbmRpZURlbGVnYXRlKTogdm9pZCB7XHJcbiAgICB0aGlzLl9pbmRpZXMuYWRkKGluZGllKTtcclxuICAgIHRoaXMuX2RpYWdub3N0aWNNYXAuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4gaW5kaWUuc2V0TWVzc2FnZXMoa2V5LCB2YWx1ZSkpO1xyXG4gICAgaW5kaWUub25EaWREZXN0cm95KCgpID0+IHtcclxuICAgICAgdGhpcy5faW5kaWVzLmRlbGV0ZShpbmRpZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogUmVtb3ZlIGFsbCB7VjJJbmRpZURlbGVnYXRlfSByZWdpc3RyaWVzIGF0dGFjaGVkIHRvIHRoaXMgYWRhcHRlciBhbmQgY2xlYXIgdGhlbS5cclxuICAvL1xyXG4gIC8vICogYGluZGllYCBBIHtWMkluZGllRGVsZWdhdGV9IHRoYXQgd2FudHMgdG8gcmVjZWl2ZSBtZXNzYWdlcy5cclxuICBwdWJsaWMgZGV0YWNoQWxsKCk6IHZvaWQge1xyXG4gICAgdGhpcy5faW5kaWVzLmZvckVhY2goKGkpID0+IGkuY2xlYXJNZXNzYWdlcygpKTtcclxuICAgIHRoaXMuX2luZGllcy5jbGVhcigpO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDYXB0dXJlIHRoZSBkaWFnbm9zdGljcyBzZW50IGZyb20gYSBsYW5nZ3VhZ2Ugc2VydmVyLCBjb252ZXJ0IHRoZW0gdG8gdGhlXHJcbiAgLy8gTGludGVyIFYyIGZvcm1hdCBhbmQgZm9yd2FyZCB0aGVtIG9uIHRvIGFueSBhdHRhY2hlZCB7VjJJbmRpZURlbGVnYXRlfXMuXHJcbiAgLy9cclxuICAvLyAqIGBwYXJhbXNgIFRoZSB7UHVibGlzaERpYWdub3N0aWNzUGFyYW1zfSByZWNlaXZlZCBmcm9tIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgdGhhdCBzaG91bGRcclxuICAvLyAgICAgICAgICAgIGJlIGNhcHR1cmVkIGFuZCBmb3J3YXJkZWQgb24gdG8gYW55IGF0dGFjaGVkIHtWMkluZGllRGVsZWdhdGV9cy5cclxuICBwdWJsaWMgY2FwdHVyZURpYWdub3N0aWNzKHBhcmFtczogUHVibGlzaERpYWdub3N0aWNzUGFyYW1zKTogdm9pZCB7XHJcbiAgICBjb25zdCBwYXRoID0gQ29udmVydC51cmlUb1BhdGgocGFyYW1zLnVyaSk7XHJcbiAgICBjb25zdCBjb2RlTWFwID0gbmV3IE1hcCgpO1xyXG4gICAgY29uc3QgbWVzc2FnZXMgPSBwYXJhbXMuZGlhZ25vc3RpY3MubWFwKChkKSA9PiB7XHJcbiAgICAgIGNvbnN0IGxpbnRlck1lc3NhZ2UgPSB0aGlzLmRpYWdub3N0aWNUb1YyTWVzc2FnZShwYXRoLCBkKTtcclxuICAgICAgY29kZU1hcC5zZXQoZ2V0Q29kZUtleShsaW50ZXJNZXNzYWdlLmxvY2F0aW9uLnBvc2l0aW9uLCBkLm1lc3NhZ2UpLCBkLmNvZGUpO1xyXG4gICAgICByZXR1cm4gbGludGVyTWVzc2FnZTtcclxuICAgIH0pO1xyXG4gICAgdGhpcy5fZGlhZ25vc3RpY01hcC5zZXQocGF0aCwgbWVzc2FnZXMpO1xyXG4gICAgdGhpcy5fZGlhZ25vc3RpY0NvZGVzLnNldChwYXRoLCBjb2RlTWFwKTtcclxuICAgIHRoaXMuX2luZGllcy5mb3JFYWNoKChpKSA9PiBpLnNldE1lc3NhZ2VzKHBhdGgsIG1lc3NhZ2VzKSk7XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IENvbnZlcnQgYSBzaW5nbGUge0RpYWdub3N0aWN9IHJlY2VpdmVkIGZyb20gYSBsYW5ndWFnZSBzZXJ2ZXIgaW50byBhIHNpbmdsZVxyXG4gIC8vIHtWMk1lc3NhZ2V9IGV4cGVjdGVkIGJ5IHRoZSBMaW50ZXIgVjIgQVBJLlxyXG4gIC8vXHJcbiAgLy8gKiBgcGF0aGAgQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBwYXRoIG9mIHRoZSBmaWxlIHRoZSBkaWFnbm9zdGljIGJlbG9uZ3MgdG8uXHJcbiAgLy8gKiBgZGlhZ25vc3RpY3NgIEEge0RpYWdub3N0aWN9IG9iamVjdCByZWNlaXZlZCBmcm9tIHRoZSBsYW5ndWFnZSBzZXJ2ZXIuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGEge1YyTWVzc2FnZX0gZXF1aXZhbGVudCB0byB0aGUge0RpYWdub3N0aWN9IG9iamVjdCBzdXBwbGllZCBieSB0aGUgbGFuZ3VhZ2Ugc2VydmVyLlxyXG4gIHB1YmxpYyBkaWFnbm9zdGljVG9WMk1lc3NhZ2UocGF0aDogc3RyaW5nLCBkaWFnbm9zdGljOiBEaWFnbm9zdGljKTogbGludGVyLk1lc3NhZ2Uge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgbG9jYXRpb246IHtcclxuICAgICAgICBmaWxlOiBwYXRoLFxyXG4gICAgICAgIHBvc2l0aW9uOiBDb252ZXJ0LmxzUmFuZ2VUb0F0b21SYW5nZShkaWFnbm9zdGljLnJhbmdlKSxcclxuICAgICAgfSxcclxuICAgICAgZXhjZXJwdDogZGlhZ25vc3RpYy5tZXNzYWdlLFxyXG4gICAgICBsaW50ZXJOYW1lOiBkaWFnbm9zdGljLnNvdXJjZSxcclxuICAgICAgc2V2ZXJpdHk6IExpbnRlclB1c2hWMkFkYXB0ZXIuZGlhZ25vc3RpY1NldmVyaXR5VG9TZXZlcml0eShkaWFnbm9zdGljLnNldmVyaXR5IHx8IC0xKSxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IENvbnZlcnQgYSBkaWFnbm9zdGljIHNldmVyaXR5IG51bWJlciBvYnRhaW5lZCBmcm9tIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgaW50b1xyXG4gIC8vIHRoZSB0ZXh0dWFsIGVxdWl2YWxlbnQgZm9yIGEgTGludGVyIHtWMk1lc3NhZ2V9LlxyXG4gIC8vXHJcbiAgLy8gKiBgc2V2ZXJpdHlgIEEgbnVtYmVyIHJlcHJlc2VudGluZyB0aGUgc2V2ZXJpdHkgb2YgdGhlIGRpYWdub3N0aWMuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGEgc3RyaW5nIG9mICdlcnJvcicsICd3YXJuaW5nJyBvciAnaW5mbycgZGVwZW5kaW5nIG9uIHRoZSBzZXZlcml0eS5cclxuICBwdWJsaWMgc3RhdGljIGRpYWdub3N0aWNTZXZlcml0eVRvU2V2ZXJpdHkoc2V2ZXJpdHk6IG51bWJlcik6ICdlcnJvcicgfCAnd2FybmluZycgfCAnaW5mbycge1xyXG4gICAgc3dpdGNoIChzZXZlcml0eSkge1xyXG4gICAgICBjYXNlIERpYWdub3N0aWNTZXZlcml0eS5FcnJvcjpcclxuICAgICAgICByZXR1cm4gJ2Vycm9yJztcclxuICAgICAgY2FzZSBEaWFnbm9zdGljU2V2ZXJpdHkuV2FybmluZzpcclxuICAgICAgICByZXR1cm4gJ3dhcm5pbmcnO1xyXG4gICAgICBjYXNlIERpYWdub3N0aWNTZXZlcml0eS5JbmZvcm1hdGlvbjpcclxuICAgICAgY2FzZSBEaWFnbm9zdGljU2V2ZXJpdHkuSGludDpcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICByZXR1cm4gJ2luZm8nO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gUHJpdmF0ZTogR2V0IHRoZSByZWNvcmRlZCBkaWFnbm9zdGljIGNvZGUgZm9yIGEgcmFuZ2UvbWVzc2FnZS5cclxuICAvLyBEaWFnbm9zdGljIGNvZGVzIGFyZSB0cmlja3kgYmVjYXVzZSB0aGVyZSdzIG5vIHN1aXRhYmxlIHBsYWNlIGluIHRoZSBMaW50ZXIgQVBJIGZvciB0aGVtLlxyXG4gIC8vIEZvciBub3csIHdlJ2xsIHJlY29yZCB0aGUgb3JpZ2luYWwgY29kZSBmb3IgZWFjaCByYW5nZS9tZXNzYWdlIGNvbWJpbmF0aW9uIGFuZCByZXRyaWV2ZSBpdFxyXG4gIC8vIHdoZW4gbmVlZGVkIChlLmcuIGZvciBwYXNzaW5nIGJhY2sgaW50byBjb2RlIGFjdGlvbnMpXHJcbiAgcHVibGljIGdldERpYWdub3N0aWNDb2RlKGVkaXRvcjogYXRvbS5UZXh0RWRpdG9yLCByYW5nZTogYXRvbS5SYW5nZSwgdGV4dDogc3RyaW5nKTogRGlhZ25vc3RpY0NvZGUgfCBudWxsIHtcclxuICAgIGNvbnN0IHBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpO1xyXG4gICAgaWYgKHBhdGggIT0gbnVsbCkge1xyXG4gICAgICBjb25zdCBkaWFnbm9zdGljQ29kZXMgPSB0aGlzLl9kaWFnbm9zdGljQ29kZXMuZ2V0KHBhdGgpO1xyXG4gICAgICBpZiAoZGlhZ25vc3RpY0NvZGVzICE9IG51bGwpIHtcclxuICAgICAgICByZXR1cm4gZGlhZ25vc3RpY0NvZGVzLmdldChnZXRDb2RlS2V5KHJhbmdlLCB0ZXh0KSkgfHwgbnVsbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRDb2RlS2V5KHJhbmdlOiBhdG9tLlJhbmdlLCB0ZXh0OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gIHJldHVybiAoW10gYXMgYW55W10pLmNvbmNhdCguLi5yYW5nZS5zZXJpYWxpemUoKSwgdGV4dCkuam9pbignLCcpO1xyXG59XHJcbiJdfQ==